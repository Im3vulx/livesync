<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveSync</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Carte des positions en temps réel</h1>
    <div id="map"></div>

    <h2>Ajouter un utilisateur</h2>
    <form id="addUserForm">
        <label for="userId">ID de l'utilisateur:</label>
        <input type="text" id="userId" required><br>
        <label for="latitude">Latitude:</label>
        <input type="number" id="latitude" step="any" required><br>
        <label for="longitude">Longitude:</label>
        <input type="number" id="longitude" step="any" required><br>
        <button type="submit">Ajouter l'utilisateur</button>
    </form>

    <h2>Accéléromètre - Suivi en temps réel</h2>

    <div id="acceleration">
        <p><strong>X:</strong> <span id="xValue">0</span></p>
        <p><strong>Y:</strong> <span id="yValue">0</span></p>
        <p><strong>Z:</strong> <span id="zValue">0</span></p>
    </div>

    <div id="rotation">
        <p><strong>Alpha:</strong> <span id="alphaValue">0</span></p>
        <p><strong>Beta:</strong> <span id="betaValue">0</span></p>
        <p><strong>Gamma:</strong> <span id="gammaValue">0</span></p>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Créer la carte
        const map = L.map('map').setView([51.505, -0.09], 13);

        // Ajouter les tuiles de carte
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Tableau pour stocker les marqueurs des utilisateurs
        let userMarkers = [];

        // Fonction pour récupérer la position de l'utilisateur
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                // Mettre à jour la carte avec la position de l'utilisateur
                map.setView([lat, lon], 13);

                // Ajouter un marqueur pour la position actuelle de l'utilisateur
                L.marker([lat, lon]).addTo(map)
                    .bindPopup('Vous êtes ici').openPopup();

                // Vous pouvez aussi envoyer la position au serveur si nécessaire
                fetch('/position', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: 'utilisateur-local',
                        lat: lat,
                        lon: lon
                    })
                }).then(response => response.json())
                    .then(data => {
                        console.log('Position envoyée:', data);
                    }).catch(error => console.error('Erreur:', error));

            }, function (error) {
                console.error('Erreur de géolocalisation:', error);
                alert('Impossible d’obtenir la localisation. Assurez-vous que votre géolocalisation est activée.');
            });
        } else {
            alert("La géolocalisation n'est pas supportée par ce navigateur.");
        }

        // WebSocket pour récupérer les positions en temps réel
        const socket = new WebSocket("ws://localhost:8080");

        // Gérer la réception des positions
        socket.onmessage = (event) => {
            const usersPositions = JSON.parse(event.data);

            // Effacer les marqueurs existants
            userMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            userMarkers = [];

            // Ajouter un nouveau marqueur pour chaque utilisateur
            usersPositions.forEach(user => {
                const marker = L.marker([user.lat, user.lon]).addTo(map)
                    .bindPopup(`<b>Utilisateur</b><br>ID: ${user.id}<br>Latitude: ${user.lat}<br>Longitude: ${user.lon}`);
                userMarkers.push(marker);
            });
        };

        // Ajouter un utilisateur manuellement
        document.getElementById('addUserForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const userId = document.getElementById('userId').value;
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);

            // Envoi des données de l'utilisateur au serveur
            fetch('/position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: userId,
                    lat: latitude,
                    lon: longitude
                })
            }).then(response => response.json())
                .then(data => {
                    console.log('Utilisateur ajouté:', data);
                }).catch(error => console.error('Erreur lors de l\'ajout de l\'utilisateur:', error));
        });

        window.addEventListener('devicemotion', function (event) {
            // Vérification des données d'accélération
            const acceleration = event.acceleration;
            const rotation = event.rotationRate;

            // Afficher les valeurs dans la console
            console.log(`Accélération : X=${acceleration.x}, Y=${acceleration.y}, Z=${acceleration.z}`);
            console.log(`Rotation : alpha=${rotation.alpha}, beta=${rotation.beta}, gamma=${rotation.gamma}`);

            // Envoi des données au serveur via WebSocket
            socket.send(JSON.stringify({
                id: 'test',
                acceleration: acceleration,
                rotation: rotation
            }));

            // Afficher les valeurs dans l'interface utilisateur (optionnel)
            document.getElementById('xValue').innerText = acceleration.x.toFixed(2);
            document.getElementById('yValue').innerText = acceleration.y.toFixed(2);
            document.getElementById('zValue').innerText = acceleration.z.toFixed(2);
            document.getElementById('alphaValue').innerText = rotation.alpha.toFixed(2);
            document.getElementById('betaValue').innerText = rotation.beta.toFixed(2);
            document.getElementById('gammaValue').innerText = rotation.gamma.toFixed(2);
        }, false);

        if (DeviceMotionEvent.requestPermission) {
            DeviceMotionEvent.requestPermission().then(response => {
                if (response === 'granted') {
                    console.log("Permission accordée pour accéder à l'accéléromètre.");
                } else {
                    console.log("Permission refusée.");
                }
            }).catch(console.error);
        }

    </script>

</body>
</html>